<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>验证码实时展示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800&display=swap">
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body{background:linear-gradient(135deg,#f0f9ff 0%,#e6f7ff 100%);color:#1e293b;font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,Roboto,sans-serif;padding:20px;min-height:100vh}
    .container{max-width:800px;margin:0 auto;animation:fadeIn .5s ease-out;transform-origin:center center;transition:transform .2s}
    .header{background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(59,130,246,.15);padding:20px 30px;margin-bottom:16px;border:1px solid #dbeafe;transition:box-shadow .3s}
    .header.flash{animation:flashHeader 1s ease-out}
    @keyframes flashHeader{0%{box-shadow:0 0 0 0 rgba(59,130,246,0)}50%{box-shadow:0 0 15px 5px rgba(59,130,246,.5)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .header h1{font-size:24px;font-weight:800;color:#2563eb;background:linear-gradient(90deg,#3b82f6,#1d4ed8);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
    .refresh-btn{background:#3b82f6;color:#fff;border:none;border-radius:10px;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px;box-shadow:0 4px 6px rgba(59,130,246,.3)}
    .refresh-btn:hover{background:#2563eb;transform:translateY(-2px);box-shadow:0 6px 8px rgba(59,130,246,.4)}
    .notice{font-size:14px;color:#ef4444;padding:10px 16px;background:#fff1f0;border-radius:8px;margin-top:0}

    /* 列表 */
    .email-list{display:flex;flex-direction:column;gap:4px;margin-bottom:20px}
    .email-item{background:#fff;border-radius:6px;padding:8px 12px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;transition:all .2s;border-left:3px solid transparent}
    .email-item.even{background:#fafafa}
    .email-item:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(59,130,246,.15)}
    .email-item.has-code{border-left-color:#13b07c;background:#f0fdf4}
    .email-item.has-code.even{background:#f0fdf4}

    .email-info{display:flex;align-items:center;gap:8px;flex:1;flex-wrap:nowrap;overflow:hidden;width:100%}
    .email-no{font-size:13px;color:#374151;font-weight:500;min-width:200px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}
    .email-copy-btn{background:#8b5cf6;color:#fff;border:none;border-radius:4px;padding:2px 6px;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;min-width:60px}
    .email-copy-btn:hover{background:#7c3aed;transform:translateY(-1px)}

    .email-code-display{display:flex;align-items:center;gap:8px;min-width:220px;flex-shrink:0}
    .code-value{font-size:14px;font-weight:600;color:#059669}
    .copy-btn{background:#10b981;color:#fff;border:none;border-radius:4px;padding:2px 6px;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0}
    .copy-btn:hover{background:#059669;transform:translateY(-1px)}
    .time-text{font-size:12px;color:#6b7280;font-style:italic}

    .polling-status{font-size:11px;color:#f59e0b;font-weight:600;white-space:nowrap;flex-shrink:0;min-width:80px}
    .stop-btn{background:#ef4444;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;min-width:50px}
    .stop-btn:hover{background:#dc2626;transform:translateY(-1px)}
    .fetch-btn{background:#3b82f6;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;min-width:50px;white-space:nowrap;flex-shrink:0}
    .fetch-btn:hover{background:#2563eb;transform:translateY(-1px)}
    .fetch-btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none;opacity:.6}
    .fetch-btn.polling{background:#f59e0b;animation:pulse 2s infinite}

    .mobile-code-line{display:none}
    @keyframes pulse{0%{opacity:1}50%{opacity:.7}100%{opacity:1}}

    /* 使用说明 & 其它样式保持不变（略去无关项以便阅读） */
    .loading{background:#fff;border-left:6px solid #3b82f6;padding:20px 30px;margin-bottom:16px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.08);text-align:center}
    .loading-text{font-size:18px;color:#6b7280;animation:pulse 1.5s infinite}
    .usage-guide{background:#fff;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.08);margin-top:20px;overflow:hidden;border:1px solid #e5e7eb}
    .guide-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px 30px;text-align:center}
    .guide-header h2{font-size:20px;font-weight:700;margin:0}
    .guide-content{padding:30px}
    .guide-section{margin-bottom:25px}
    .guide-section:last-child{margin-bottom:0}
    .guide-section h3{font-size:16px;font-weight:600;color:#374151;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e5e7eb}
    .guide-section ul{list-style:none;padding:0;margin:0}
    .guide-section li{padding:8px 0;color:#6b7280;font-size:14px;line-height:1.5;position:relative;padding-left:20px}
    .guide-section li:before{content:"•";color:#3b82f6;font-weight:bold;position:absolute;left:0;top:8px}

    /* 手机端 */
    @media (max-width:768px){
      .email-item{flex-direction:column;align-items:flex-start;gap:8px}
      .email-info{justify-content:space-between}
      .email-no{min-width:200px;max-width:200px;font-size:11px;flex:1}
      .email-code-display,.time-text{display:none}
      .mobile-code-line{display:flex;align-items:center;gap:8px;width:100%;margin-left:33px;font-size:11px}
      .mobile-time-display{color:#6b7280;font-style:italic}
    }
    @media (max-width:480px){
      .email-no{min-width:150px;max-width:150px;font-size:10px}
      .email-copy-btn,.copy-btn,.fetch-btn,.stop-btn{font-size:9px;padding:2px 4px;min-height:24px;min-width:44px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>验证码列表</h1>
        <button class="refresh-btn" id="refreshBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
          刷新
        </button>
      </div>
      <div class="notice">如果验证码一直没来请联系 A Kun</div>
    </div>

    <div id="content">
      <div class="loading">
        <div class="loading-text">正在加载邮箱列表，请稍候...</div>
        <div id="timerStatus" style="font-size:12px;color:#666;margin-top:10px;"></div>
      </div>
    </div>

    <!-- 使用说明（原样保留） -->
    <div class="usage-guide">
      <div class="guide-header"><h2>📖 使用说明</h2></div>
      <div class="guide-content">
        <div class="guide-section">
          <h3>🎯 基本操作</h3>
          <ul>
            <li><strong>取码</strong>：点击邮箱右侧的"取码"按钮开始轮询该邮箱</li>
            <li><strong>停止</strong>：轮询过程中点击"停止"按钮可立即停止轮询</li>
            <li><strong>刷新</strong>：点击右上角"刷新"按钮重新获取邮箱列表</li>
          </ul>
        </div>
        <div class="guide-section">
          <h3>📋 功能说明</h3>
          <ul>
            <li><strong>查询机制</strong>：每次只能查询一个邮箱，开始新查询会自动停止其他查询</li>
            <li><strong>查询时长</strong>：每个邮箱查询5分钟，自动停止</li>
            <li><strong>验证码更新</strong>：只有发现新验证码才会更新显示，避免重复</li>
            <li><strong>时间显示</strong>：显示验证码的实际获取时间</li>
          </ul>
        </div>
        <div class="guide-section">
          <h3>📋 复制功能</h3>
          <ul>
            <li><strong>邮箱复制</strong>：点击邮箱地址后的紫色"邮箱复制"按钮</li>
            <li><strong>验证码复制</strong>：点击验证码后的绿色"码复制"按钮</li>
            <li><strong>复制反馈</strong>：复制成功会显示"已复制"</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwB6O-K_c0fudZY-02_qhGG_1-tlUIU7YnnEPScYsmZIVIZj2-M_HuREy60HJGf5AerXQ/exec';
const REFRESH_INTERVAL = 3000;
let emailList = [];
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

// 轮询状态
let pollingIntervals = {};
let pollingStatus = {};
const POLLING_DURATION = 5 * 60 * 1000;

// 初始化
if (document.readyState === 'complete') { initializeCodeCollection(); }
else { window.addEventListener('load', initializeCodeCollection); }

document.getElementById('refreshBtn').addEventListener('click', fetchEmailList);

function initializeCodeCollection(){
  fetchEmailList();
  // 每秒刷新倒计时文本
  setInterval(() => {
    Object.keys(pollingStatus).forEach(email => {
      const st = pollingStatus[email];
      if (st && st.isActive) updatePollingDisplay(email);
    });
  }, 1000);
}

// 获取邮箱列表(JSONP)
function fetchEmailList(){
  const cb = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  const s = document.createElement('script');
  s.src = API_URL + '?action=getEmailList&callback=' + cb;
  const to = setTimeout(() => { cleanup(); renderEmailList([]); }, 10000);

  window[cb] = (data) => {
    clearTimeout(to); cleanup();
    if (data.status === 'OK' && data.emails) {
      emailList = data.emails;
      renderEmailList(emailList);
    } else {
      renderEmailList([]);
    }
  };

  s.onerror = () => { clearTimeout(to); cleanup(); renderEmailList([]); };
  document.head.appendChild(s);

  function cleanup(){ try{ document.head.removeChild(s);}catch{} delete window[cb]; }
}

// 渲染列表
function renderEmailList(emails){
  const content = document.getElementById('content');
  if (!emails.length){
    content.innerHTML = `
      <div class="loading"><div class="loading-text">未获取到邮箱列表</div></div>
    `;
    return;
  }

  const html = emails.map((email, index) => {
    const isEven = index % 2 === 0;

    if (isMobile){
      // 手机端：按钮单独一行，验证码/时间在第二行
      return `
      <div class="email-item ${isEven ? 'even':'odd'}" data-email="${email}" data-index="${index}">
        <div class="email-info">
          <span class="email-no">${index+1}. ${email}</span>
          <button class="email-copy-btn" onclick="copyToClipboard('${email}')" ontouchstart="copyToClipboard('${email}')">邮箱复制</button>
        </div>

        <div class="email-info">
          <span class="polling-status" id="polling-${index}"></span>
          <button class="stop-btn" id="stop-${index}" style="display:none" onclick="stopPollingForEmail('${email}', this)" ontouchstart="stopPollingForEmail('${email}', this)">停止</button>
          <button class="fetch-btn" id="fetch-${index}" onclick="fetchCodeForEmail('${email}', this)" ontouchstart="fetchCodeForEmail('${email}', this)">取码</button>
        </div>

        <div class="mobile-code-line" id="mobileCodeLine-${index}"></div>
      </div>`;
    }

    // 桌面端：一行包括邮箱/复制/验证码/时间/状态/停止/取码
    return `
    <div class="email-item ${isEven ? 'even':'odd'}" data-email="${email}" data-index="${index}">
      <div class="email-info">
        <span class="email-no">${index+1}. ${email}</span>
        <button class="email-copy-btn" onclick="copyToClipboard('${email}')" ontouchstart="copyToClipboard('${email}')">邮箱复制</button>

        <span class="email-code-display" id="codeDisplay-${index}">
          <span class="code-value"></span>
          <button class="copy-btn" id="copyCodeBtn-${index}" style="display:none">码复制</button>
          <span class="time-text" id="fetchTime-${index}"></span>
        </span>

        <span class="polling-status" id="polling-${index}"></span>
        <button class="stop-btn" id="stop-${index}" style="display:none" onclick="stopPollingForEmail('${email}', this)" ontouchstart="stopPollingForEmail('${email}', this)">停止</button>
        <button class="fetch-btn" id="fetch-${index}" onclick="fetchCodeForEmail('${email}', this)" ontouchstart="fetchCodeForEmail('${email}', this)">取码</button>
      </div>
    </div>`;
  }).join('');

  content.innerHTML = `<div class="email-list">${html}</div>`;
}

// 单次查询（JSONP）
function fetchCodeOnce(email, button){
  const emailIndex = emailList.findIndex(e => e === email);

  // 取当前显示的验证码（桌面端）
  let currentCode = null;
  if (emailIndex !== -1 && !isMobile){
    const valEl = document.querySelector(`#codeDisplay-${emailIndex} .code-value`);
    if (valEl) currentCode = (valEl.textContent || '').trim();
  }

  const cb = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  const s = document.createElement('script');
  let url = API_URL + '?email=' + encodeURIComponent(email) + '&callback=' + cb;
  if (currentCode) url += '&currentCode=' + encodeURIComponent(currentCode);
  s.src = url;

  const to = setTimeout(() => { cleanup(); console.log('查询超时', email); }, 10000);

  window[cb] = (data) => {
    clearTimeout(to); cleanup();
    if (data.status === 'OK' && data.data){
      renderCodeDisplay(data.data, email);
    }
  };

  document.head.appendChild(s);
  function cleanup(){ try{ document.head.removeChild(s);}catch{} delete window[cb]; }
}

// 渲染验证码到对应行
function renderCodeDisplay(data, targetEmail){
  const index = emailList.findIndex(e => e === targetEmail);
  if (index === -1) return;

  const emailItem = document.querySelector(`[data-email="${targetEmail}"]`);
  if (!emailItem) return;

  if (data.error){
    if (isMobile){
      const line = document.getElementById(`mobileCodeLine-${index}`);
      if (line) line.innerHTML = `<span style="color:#ef4444;">❌ ${data.error}</span>`;
    }else{
      const codeBox = document.getElementById(`codeDisplay-${index}`);
      if (codeBox){
        codeBox.querySelector('.code-value').textContent = `❌ ${data.error}`;
        codeBox.querySelector('.code-value').style.color = '#ef4444';
        const copyBtn = document.getElementById(`copyCodeBtn-${index}`);
        if (copyBtn) copyBtn.style.display = 'none';
        const timeEl = document.getElementById(`fetchTime-${index}`);
        if (timeEl) timeEl.textContent = '';
      }
    }
    emailItem.classList.remove('has-code');
    return;
  }

  // 有验证码
  if (data.codes && data.codes.length){
    const latest = data.codes[0];
    const sheetTime = latest.time ? new Date(latest.time).toLocaleTimeString('zh-CN') : new Date().toLocaleTimeString('zh-CN');

    if (isMobile){
      const line = document.getElementById(`mobileCodeLine-${index}`);
      if (line){
        line.innerHTML = `
          <div class="mobile-code-display">
            ${latest.code}
            <button class="copy-btn" onclick="copyToClipboard('${latest.code}')" ontouchstart="copyToClipboard('${latest.code}')">码复制</button>
          </div>
          <div class="mobile-time-display">来码时间: ${sheetTime}</div>`;
      }
    }else{
      const codeBox = document.getElementById(`codeDisplay-${index}`);
      if (codeBox){
        codeBox.querySelector('.code-value').style.color = '#059669';
        codeBox.querySelector('.code-value').textContent = latest.code;
        const copyBtn = document.getElementById(`copyCodeBtn-${index}`);
        if (copyBtn){
          copyBtn.style.display = 'inline-block';
          copyBtn.onclick = () => copyToClipboard(latest.code);
          copyBtn.ontouchstart = () => copyToClipboard(latest.code);
        }
        const timeEl = document.getElementById(`fetchTime-${index}`);
        if (timeEl) timeEl.textContent = `来码时间: ${sheetTime}`;
      }
    }
    emailItem.classList.add('has-code');
  }else{
    // 清空
    if (isMobile){
      const line = document.getElementById(`mobileCodeLine-${index}`);
      if (line) line.innerHTML = '';
    }else{
      const codeBox = document.getElementById(`codeDisplay-${index}`);
      if (codeBox){
        codeBox.querySelector('.code-value').textContent = '';
        const copyBtn = document.getElementById(`copyCodeBtn-${index}`);
        if (copyBtn) copyBtn.style.display = 'none';
        const timeEl = document.getElementById(`fetchTime-${index}`);
        if (timeEl) timeEl.textContent = '';
      }
    }
    emailItem.classList.remove('has-code');
  }
}

// 点击“取码”
function fetchCodeForEmail(email, btn){
  if (btn && btn.disabled) return;
  if (pollingStatus[email] && pollingStatus[email].isActive) return;
  startPolling(email, btn);
}

// 开始轮询
function startPolling(email, btn){
  // 停掉其他
  Object.keys(pollingStatus).forEach(e => { if (e!==email) stopPolling(e); });

  pollingStatus[email] = { isActive:true, startTime:Date.now(), endTime:Date.now()+POLLING_DURATION };

  fetchCodeOnce(email, btn);
  pollingIntervals[email] = setInterval(() => {
    const left = pollingStatus[email].endTime - Date.now();
    if (left<=0){ stopPolling(email); return; }
    fetchCodeOnce(email, btn);
  }, REFRESH_INTERVAL);

  // 自动停止
  setTimeout(() => stopPolling(email), POLLING_DURATION);

  updatePollingDisplay(email);
}

// 停止
function stopPolling(email){
  if (pollingIntervals[email]){ clearInterval(pollingIntervals[email]); delete pollingIntervals[email]; }
  if (pollingStatus[email]) pollingStatus[email].isActive = false;
  updatePollingDisplay(email);
}

// 供按钮调用
function stopPollingForEmail(email){ stopPolling(email); }

// 根据状态更新一行的控件显示
function updatePollingDisplay(email){
  const item = document.querySelector(`[data-email="${email}"]`);
  if (!item) return;
  const index = item.getAttribute('data-index');

  const isPolling = pollingStatus[email] && pollingStatus[email].isActive;
  const remaining = isPolling ? Math.max(0, Math.ceil((pollingStatus[email].endTime - Date.now())/1000)) : 0;

  const pollingEl = document.getElementById(`polling-${index}`);
  const fetchBtn = document.getElementById(`fetch-${index}`);
  const stopBtn  = document.getElementById(`stop-${index}`);

  if (pollingEl) pollingEl.textContent = isPolling ? `查询中 (${remaining}s)` : '';

  if (fetchBtn){
    fetchBtn.textContent = isPolling ? '查询中' : '取码';
    fetchBtn.disabled = !!isPolling;
    fetchBtn.classList.toggle('polling', !!isPolling);
  }

  if (stopBtn){
    stopBtn.style.display = isPolling ? 'inline-block' : 'none';
  }
}

// 复制
function copyToClipboard(text){
  try{
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px'; ta.style.top='-9999px';
    document.body.appendChild(ta); ta.focus(); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  }catch(e){ console.error('复制失败', e); }
}
</script>
</body>
</html>
